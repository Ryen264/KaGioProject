#include "View.h"
#include "Model.h"
#include "Control.h"
#include "Global.h"
#include <Windows.h>
#include <stdio.h>

/*
Bổ sung cơ bản:
    1.  save/load
    2.  nhận biết thắng - thua - hòa
    3.  thêm hiệu ứng thắng - thua - hòa, thay vì chỉ in chữ báo hiệu
    4.  thêm giao diện, như hiển thị thông số, ...
    5.  thêm màn hình chính, hiển thị danh sách menu
*/

int main()
{
    FixConsoleWindow();
    StartGame();
    GotoXY(5, 2);
    bool validEnter = true; //biến kiểm tra nhập hợp lệ
    while (1)
    {
        _COMMAND = toupper(getchar());

        //xóa dấu vết di chuyển
        GotoXY(_X + 1, _Y);
        printf("\b ");
        
        //xử lý getchar thừa
        int ch{};
        while ((ch = getchar()) == ' ');
        
        switch (_COMMAND)
        {
        case 27:    //thoát trò chơi, ACSII(27) = escape
            ExitGame();
            return 0;
            break;
        case 'D':
            MoveRight();
            break;
        case 'A':
            MoveLeft();
            break;
        case 'W':
            MoveUp();
            break;
        case 'S':
            MoveDown();
            break;
        case 13:    //đánh dấu trên màn hình, ACSII(13) = carriage return
        {
            switch (CheckBoard(_X, _Y))
            {
            case -1:    //người chơi 1
                printf("X");
                break;
            case 1:     //người chơi 2
                printf("O");
                break;
            case 0:     //đánh vào ô đã có đánh
                validEnter = false;
                break;
            }

            //Kiểm tra và xử lý thắng thua
            if (validEnter)
            {
                switch (ProcessFinish(TestBoard()))
                {
                case -1: case 1: case 0:
                    if (AskContinue() != 'Y')
                    {
                        ExitGame();
                        return 0;
                    }
                    else StartGame();
                }
            }
            validEnter = true; //Mở khóa
        }
        }
    }

    return 0;
}
